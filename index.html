<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÖ Sistem Pengurusan Olahraga SK Abang Gesa 2025</title>
    <style>
        /* ============ CSS ASAS UNTUK UI/UX =========== */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f4f9; color: #333; }
        #header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
        #nav-menu { background-color: #34495e; padding: 10px 0; text-align: center; }
        .nav-btn { background-color: #3498db; color: white; border: none; padding: 10px 20px; margin: 0 5px; cursor: pointer; border-radius: 5px; transition: background-color 0.3s; }
        .nav-btn:hover { background-color: #2980b9; }
        #content { padding: 20px; max-width: 1200px; margin: 20px auto; background-color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .view-section { display: none; }
        h2, h3 { color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        form { background-color: #ecf0f1; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        input[type="text"], input[type="number"], select { padding: 10px; margin: 5px 0 10px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%; }
        button[type="submit"], .action-btn { background-color: #2ecc71; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button[type="submit"]:hover, .action-btn:hover { background-color: #27ae60; }
        .reset-btn { background-color: #e74c3c; }
        .reset-btn:hover { background-color: #c0392b; }
        .label-group { margin-bottom: 15px; }
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        
        /* Gaya Jadual Papan Mata */
        #mata-rumah-sukan table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #mata-rumah-sukan th, #mata-rumah-sukan td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #mata-rumah-sukan th { background-color: #3498db; color: white; }
        
        /* Gaya Baris Keputusan */
        .keputusan-acara { margin-top: 20px; border: 1px solid #ccc; border-radius: 5px; padding: 15px; }
        .keputusan-acara h3 { background-color: #95a5a6; color: white; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 5px 5px 0 0; }
        .keputusan-acara table { width: 100%; border-collapse: collapse; }
        .keputusan-acara th, .keputusan-acara td { border: 1px solid #eee; padding: 8px; text-align: left; }
        
        /* Warna Rumah Sukan */
        .KUNING { background-color: #fff9c4; }
        .BIRU { background-color: #bbdefb; }
        .MERAH { background-color: #ffcdd2; }
        .HIJAU { background-color: #c8e6c9; }
        
        /* Warna Pingat */
        .pingat-Emas { background-color: #ffd700 !important; font-weight: bold; }
        .pingat-Perak { background-color: #c0c0c0 !important; font-weight: bold; }
        .pingat-Gangsa { background-color: #cd7f32 !important; font-weight: bold; }

        /* Login */
        #user-auth { background-color: #f1c40f; padding: 10px; text-align: center; margin-bottom: 20px; border-radius: 5px; }

    </style>
</head>
<body>
    <div id="header">
        <h1>üèÖ Sistem Pengurusan Olahraga SK Abang Gesa 2025</h1>
        <p>Sistem Client-Side dengan Pangkalan Data Awan (Firebase Firestore)</p>
    </div>

    <div id="user-auth">
        <h2>Pilih Peranan Anda</h2>
        <button class="action-btn" onclick="setUserRole('Admin')">Admin (Jana Keputusan)</button>
        <button class="action-btn" onclick="setUserRole('User')">Pengguna (Lihat Papan Mata)</button>
    </div>

    <div id="nav-menu">
        <button class="nav-btn" onclick="showView('dashboard')">Papan Mata</button>
        <button class="nav-btn admin-only" onclick="showView('janaIndividu')" style="display:none;">Jana Keputusan Individu</button>
        <button class="nav-btn admin-only" onclick="showView('janaRelay')" style="display:none;">Jana Keputusan Relay</button>
        <button class="nav-btn admin-only" onclick="showView('muatRekod')" style="display:none;">Muat Naik Rekod</button>
        <button class="nav-btn admin-only reset-btn" onclick="resetSemuaData()" style="display:none;">RESET SEMUA DATA</button>
    </div>

    <div id="content">
        <div id="dashboard" class="view-section">
            <h2>Papan Mata Keseluruhan</h2>
            <div id="mata-rumah-sukan">
                </div>
            
            <hr>

            <h2>Keputusan Acara Yang Telah Selesai</h2>
            <div id="keputusan-keseluruhan">
                </div>
        </div>

        <div id="janaIndividu" class="view-section">
            <h2>Jana Keputusan Acara Individu</h2>
            <form id="form-individu">
                <div class="label-group">
    <label for="jenis-acara">Jenis Acara:</label>
    <select id="jenis-acara" required>
        <option value="">Pilih Jenis</option>
        <option value="Individu">Acara Individu</option>
        <option value="Relay">Acara Relay</option>
    </select>
</div>

<div class="label-group">
    <label for="acara-dinamik">Acara:</label>
    <select id="acara-dinamik" required></select>
</div>

                <h3>Input Kedudukan (Top 5)</h3>
                <div class="input-group">
                    <div class="label-group">
                        <label for="n1">Tempat Pertama (Emas):</label>
                        <input type="text" id="n1" placeholder="Nama Peserta (Emas)" required>
                        <select id="r1" required>
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="c1" placeholder="Catatan/Masa (e.g., 12.5s)" required>
                    </div>
                    <div class="label-group">
                        <label for="n2">Tempat Kedua (Perak):</label>
                        <input type="text" id="n2" placeholder="Nama Peserta (Perak)">
                        <select id="r2">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="c2" placeholder="Catatan/Masa">
                    </div>
                    <div class="label-group">
                        <label for="n3">Tempat Ketiga (Gangsa):</label>
                        <input type="text" id="n3" placeholder="Nama Peserta (Gangsa)">
                        <select id="r3">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="c3" placeholder="Catatan/Masa">
                    </div>
                    <div class="label-group">
                        <label for="n4">Tempat Keempat:</label>
                        <input type="text" id="n4" placeholder="Nama Peserta">
                        <select id="r4">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="c4" placeholder="Catatan/Masa">
                    </div>
                    <div class="label-group">
                        <label for="n5">Tempat Kelima:</label>
                        <input type="text" id="n5" placeholder="Nama Peserta">
                        <select id="r5">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="c5" placeholder="Catatan/Masa">
                    </div>
                </div>

                <button type="button" onclick="simpanKeputusanIndividu()">Simpan Keputusan Individu</button>
            </form>
        </div>

        <div id="janaRelay" class="view-section">
            <h2>Jana Keputusan Acara Relay (4x100m)</h2>
            <form id="form-relay">
                <div class="label-group">
                    <label for="kategori-relay">Kategori Umur:</label>
                    <select id="kategori-relay" required></select>
                </div>
                <input type="hidden" id="acara-relay" value="4X100 METER">

                <h3>Input Kedudukan (Top 4)</h3>
                <div class="input-group">
                    <div class="label-group">
                        <label for="rr1">Tempat Pertama (Emas):</label>
                        <select id="rr1" required>
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="rc1" placeholder="Masa (e.g., 55.0s)" required>
                    </div>
                    <div class="label-group">
                        <label for="rr2">Tempat Kedua (Perak):</label>
                        <select id="rr2">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="rc2" placeholder="Masa">
                    </div>
                    <div class="label-group">
                        <label for="rr3">Tempat Ketiga (Gangsa):</label>
                        <select id="rr3">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="rc3" placeholder="Masa">
                    </div>
                    <div class="label-group">
                        <label for="rr4">Tempat Keempat:</label>
                        <select id="rr4">
                            <option value="">Pilih Rumah</option>
                            <option value="KUNING">KUNING</option>
                            <option value="BIRU">BIRU</option>
                            <option value="MERAH">MERAH</option>
                            <option value="HIJAU">HIJAU</option>
                        </select>
                        <input type="text" id="rc4" placeholder="Masa">
                    </div>
                </div>

                <button type="button" onclick="simpanKeputusanRelay()">Simpan Keputusan Relay</button>
            </form>
        </div>

        <div id="muatRekod" class="view-section">
            <h2>Muat Naik Fail Rekod Kejohanan (.csv)</h2>
            <form id="form-rekod">
                <p>Format CSV: **Acara,Kategori,Nama Peserta,Rumah Sukan,Catatan**</p>
                <p>Contoh: 100 METER,12 TAHUN,ALI BIN ABU,MERAH,12.5s</p>
                <label for="csv-rekod">Pilih Fail CSV Rekod:</label>
                <input type="file" id="csv-rekod" accept=".csv" required>
                <button type="button" onclick="muatNaikRekod()">Muat Naik & Simpan Rekod Baru</button>
            </form>
            <hr>
            <h3>Status Rekod Semasa</h3>
            <p>Rekod akan dipaparkan dalam konsol pelayar anda selepas dimuatkan.</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
<script>
    // ============ JAVASCRIPT LOGIC ============

    // --- KONFIGURASI FIREBASE ---
    // *** GANTI DENGAN KUNCI ANDA DARI KONSOL FIREBASE ***
    const firebaseConfig = {
        apiKey: "AIzaSyBIMgGfnCHN67bb9jYVn_tdIACHUFMNfX0",
        authDomain: "sts2025-bf7ee.firebaseapp.com",
        projectId: "sts2025-bf7ee",
        storageBucket: "sts2025-bf7ee.firebasestorage.app",
        messagingSenderId: "888830159138",
        appId: "1:888830159138:web:18db263e1923dc87e61d7b",
        measurementId: "G-N1QZ824EFC"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth(); 

    // --- COLLECTION IDS YANG DIUBAH UNTUK MEMADANKAN RULES ---
    const APP_ID = firebaseConfig.appId; 
    // Laluan data awam: artifacts/{appId}/public/data/keputusan_acara/{document}
    const BASE_PATH = `artifacts/${APP_ID}/public/data`;
    const KEPUTUSAN_COLLECTION_PATH = `${BASE_PATH}/keputusan_acara`;
    // Mata dan Rekod akan disimpan sebagai dokumen khas di dalam koleksi ini.
    // -----------------------------------------------------------------

    let USER_ROLE = 'User'; 
    let KEPUTUSAN_KESELURUHAN = []; 
    
    let MATA_RUMAH_SUKAN = { 
        'KUNING': { mata: 0, emas: 0, perak: 0, gangsa: 0 }, 
        'BIRU': { mata: 0, emas: 0, perak: 0, gangsa: 0 }, 
        'MERAH': { mata: 0, emas: 0, perak: 0, gangsa: 0 }, 
        'HIJAU': { mata: 0, emas: 0, perak: 0, gangsa: 0 } 
    }; 
    
    let REKOD_KEJOHANAN = {}; // Disimpan sebagai objek untuk carian yang cepat (Acara_Kategori: {nama, rumah, catatan})

    const ACARA_INDIVIDU = ['100 METER', '200 METER', 'LOMPAT JAUH', 'LOMPAT TINGGI', 'LONTAR PELURU', '100 METER BERPAGAR'];
    const ACARA_RELAY = ['4X100 METER'];
    const ACARA_PADANG = ['LOMPAT JAUH', 'LOMPAT TINGGI', 'LONTAR PELURU']; 
    const KATEGORI_UMUR = ['7 TAHUN', '8 TAHUN', '9 TAHUN', '10 TAHUN', '11 TAHUN', '12 TAHUN'];
    const SKALA_MATA_INDIVIDU = [6, 4, 3, 1, 1, 1, 1, 1]; // 1st hingga 8th
    const SKALA_MATA_RELAY = [6, 4, 3, 1, 1, 1, 1, 1]; // 1st hingga 8th
    
    // ===========================================
    // FUNGSI FIREBASE (Paling Penting)
    // ===========================================

    /** * BARU: Admin mesti log masuk untuk membenarkan penulisan data.
     * Kami menggunakan Anonymous Sign-in sebagai contoh untuk memenuhi syarat auth != null.
     * Untuk produksi, ganti dengan Email/Google Auth.
     */
    async function adminLogin() {
        try {
            // Sila tukar kepada kaedah log masuk sebenar (Email/Password, Google, dll.)
            const result = await auth.signInAnonymously();
            
            if (result.user) {
                setUserRole('Admin'); // Set semula peranan selepas log masuk berjaya
                alert(`Admin berjaya log masuk! Anda kini boleh menyimpan keputusan.`);
                document.getElementById('user-auth').innerHTML = '<p style="color: green; font-weight: bold;">‚úÖ Admin Berjaya Log Masuk</p>';
            }
        } catch (error) {
            console.error("Ralat Log Masuk Admin:", error);
            alert(`RALAT LOG MASUK: Gagal log masuk. ${error.message}. Sila semak konsol dan seting Firebase Auth.`);
        }
    }


    /** * Fungsi untuk menyimpan data ke Firestore (Write: auth != null). */
    async function simpanDataKeFirebase() {
        if (!auth.currentUser) {
             alert('RALAT: Anda mesti log masuk sebagai Admin untuk menyimpan data keputusan!');
             return;
        }
        
        console.log("Menyimpan data ke Firebase...");
        try {
            // 1. Simpan Mata dan Rekod sebagai dokumen khas
            // Dokumen ID: 'sk_abang_gesa_mata' dan 'rekod_rasmi'
            await db.collection(KEPUTUSAN_COLLECTION_PATH).doc('sk_abang_gesa_mata').set(MATA_RUMAH_SUKAN);
            await db.collection(KEPUTUSAN_COLLECTION_PATH).doc('rekod_rasmi').set(REKOD_KEJOHANAN);
            
            // 2. Simpan Keputusan Acara (Padam & Ganti semua keputusan acara)
            // Hanya query dokumen yang mempunyai field 'jenis' untuk mengelakkan padam 'mata'/'rekod'
            const snapshot = await db.collection(KEPUTUSAN_COLLECTION_PATH).where('jenis', 'in', ['Individu', 'Relay']).get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            // Simpan keputusan baru
            const newBatch = db.batch();
            KEPUTUSAN_KESELURUHAN.forEach(k => {
                const newDocRef = db.collection(KEPUTUSAN_COLLECTION_PATH).doc();
                newBatch.set(newDocRef, { ...k, jenis: k.jenis || 'Individu' }); 
            });
            await newBatch.commit();

            console.log('Semua data kejohanan berjaya disimpan ke Firestore!');
        } catch (e) {
            console.error("Ralat semasa menyimpan data ke Firestore: ", e);
            alert('RALAT: Gagal menyimpan data ke pangkalan data awan. Lihat konsol untuk butiran.');
        }
    }

    /** * Fungsi untuk memuatkan data dari Firestore (Read: if true). */
    async function muatDataDariFirebase() {
        try {
            console.log("Memuatkan data dari Firebase...");
            
            // 1. Muat Mata dan Rekod
            const mataDoc = await db.collection(KEPUTUSAN_COLLECTION_PATH).doc('sk_abang_gesa_mata').get();
            if (mataDoc.exists) {
                MATA_RUMAH_SUKAN = mataDoc.data();
            }
            
            const rekodDoc = await db.collection(KEPUTUSAN_COLLECTION_PATH).doc('rekod_rasmi').get();
            if (rekodDoc.exists) {
                REKOD_KEJOHANAN = rekodDoc.data();
                console.log('Rekod Kejohanan dimuatkan:', REKOD_KEJOHANAN);
            }

            // 2. Muat Keputusan Keseluruhan (hanya dokumen acara)
            const keputusanSnapshot = await db.collection(KEPUTUSAN_COLLECTION_PATH).where('jenis', 'in', ['Individu', 'Relay']).get();
            KEPUTUSAN_KESELURUHAN = [];
            keputusanSnapshot.forEach(doc => {
                KEPUTUSAN_KESELURUHAN.push(doc.data());
            });
            console.log(`${KEPUTUSAN_KESELURUHAN.length} keputusan acara dimuatkan.`);
            
            // Selepas memuatkan, kemas kini UI
            generateMataRumahSukanTable();
            updateDashboard();
            
        } catch (e) {
            console.error("Ralat semasa memuatkan data dari Firestore: ", e);
            alert('RALAT: Gagal memuatkan data dari pangkalan data awan. Data mungkin kosong atau ralat konfigurasi.');
        }
    }
    
    /** * Fungsi untuk RESET SEMUA DATA di Firestore. */
    async function resetSemuaData() {
        if (!auth.currentUser) {
             alert('RALAT: Anda mesti log masuk sebagai Admin untuk mereset data!');
             return;
        }

        if (confirm('ADAKAH ANDA PASTI? Ini akan memadam SEMUA keputusan, mata, dan rekod yang disimpan dalam Firestore!')) {
            try {
                // 1. Padam Dokumen Khas (Mata & Rekod)
                await db.collection(KEPUTUSAN_COLLECTION_PATH).doc('sk_abang_gesa_mata').delete();
                await db.collection(KEPUTUSAN_COLLECTION_PATH).doc('rekod_rasmi').delete();
                
                // 2. Padam Semua Keputusan Acara
                const snapshot = await db.collection(KEPUTUSAN_COLLECTION_PATH).where('jenis', 'in', ['Individu', 'Relay']).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                // Reset pemboleh ubah global
                KEPUTUSAN_KESELURUHAN = [];
                MATA_RUMAH_SUKAN = { 
                    'KUNING': { mata: 0, emas: 0, perak: 0, gangsa: 0 }, 
                    'BIRU': { mata: 0, emas: 0, perak: 0, gangsa: 0 }, 
                    'MERAH': { mata: 0, emas: 0, perak: 0, gangsa: 0 }, 
                    'HIJAU': { mata: 0, emas: 0, perak: 0, gangsa: 0 } 
                };
                REKOD_KEJOHANAN = {};
                
                alert('Data kejohanan telah berjaya dipadam dan direset dari Firestore!');
                window.location.reload(); 
            } catch (e) {
                 console.error("Ralat semasa reset data: ", e);
                 alert('RALAT: Gagal mereset data. Lihat konsol untuk butiran.');
            }
        }
    }

    // ===========================================
    // FUNGSI UTILITI UMUM
    // ===========================================

    function setUserRole(role) {
        USER_ROLE = role;
        const adminElements = document.querySelectorAll('.admin-only');
        
        if (role === 'Admin') {
            adminElements.forEach(el => el.style.display = 'inline-block');
            if (!auth.currentUser) {
                document.getElementById('user-auth').innerHTML = '<h2>Admin: Sila Log Masuk</h2><button class="action-btn" onclick="adminLogin()">Log Masuk Admin</button>';
            } else {
                document.getElementById('user-auth').innerHTML = '<p style="color: green; font-weight: bold;">‚úÖ Admin Berjaya Log Masuk</p>';
            }
            showView('janaIndividu');
        } else {
            adminElements.forEach(el => el.style.display = 'none');
            document.getElementById('user-auth').innerHTML = '<h2>Pilih Peranan Anda</h2><button class="action-btn" onclick="setUserRole(\'Admin\')">Admin (Jana Keputusan)</button><button class="action-btn" onclick="setUserRole(\'User\')">Pengguna (Lihat Papan Mata)</button>';
            showView('dashboard');
        }
    }

    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(viewId).style.display = 'block';
    }

    // --- Fungsi Dinamik untuk Borang Acara ---

    function updateAcaraDropdown() {
        const jenis = document.getElementById('jenis-acara').value;
        const acaraSelect = document.getElementById('acara-dinamik');
        
        // Kosongkan senarai acara
        acaraSelect.innerHTML = '<option value="">Pilih Acara</option>';
        
        let acaraList = [];
        if (jenis === 'Individu') {
            acaraList = ACARA_INDIVIDU;
        } else if (jenis === 'Relay') {
            acaraList = ACARA_RELAY;
        }
        
        // Isi semula dropdown
        acaraList.forEach(acara => {
            const option = document.createElement('option');
            option.value = acara;
            option.textContent = acara;
            acaraSelect.appendChild(option);
        });

        // Tunjuk atau sembunyi input field mengikut jenis acara
        showHideInputFields(jenis);
    }

    function showHideInputFields(jenis) {
        const individuInputs = document.querySelectorAll('#form-individu .label-group:nth-child(n+4):nth-child(-n+8)');
        const relayInputs = document.querySelectorAll('#form-individu .label-group:nth-child(n+9):nth-child(-n+12)');
        
        if (jenis === 'Individu') {
            individuInputs.forEach(el => el.style.display = 'block');
            relayInputs.forEach(el => el.style.display = 'none');
        } else if (jenis === 'Relay') {
            individuInputs.forEach(el => el.style.display = 'none');
            relayInputs.forEach(el => el.style.display = 'block');
        } else {
            individuInputs.forEach(el => el.style.display = 'block');
            relayInputs.forEach(el => el.style.display = 'none');
        }
    }

    // --- Fungsi Pengiraan Mata/Kedudukan/Rekod ---
    
    function parseCatatan(catatan) {
        // Tukar Catatan (e.g., 12.5s, 5.2m) kepada float untuk perbandingan
        const value = parseFloat(catatan.replace(/[^\d.]/g, ''));
        const isDistance = catatan.includes('m') || catatan.includes('cm'); // True jika acara padang
        return { value, isDistance };
    }

    function SemakRekod(acara, kategori, catatan) {
        const kunci = `${acara}_${kategori}`;
        const { value: catatanBaru, isDistance } = parseCatatan(catatan);

        if (!REKOD_KEJOHANAN[kunci]) {
            // Rekod baru
            REKOD_KEJOHANAN[kunci] = {
                nama: '',
                rumah: '',
                catatan: catatan,
                jenis: isDistance ? 'Padang' : 'Balapan'
            };
            return true; // Sentiasa rekod jika tiada rekod lama
        }

        const { value: catatanLama } = parseCatatan(REKOD_KEJOHANAN[kunci].catatan);

        let pecahRekod = false;
        
        if (isDistance) {
            // Acara Padang: Lebih besar lebih baik
            if (catatanBaru > catatanLama) {
                pecahRekod = true;
            }
        } else {
            // Acara Balapan (Masa): Lebih kecil lebih baik
            if (catatanBaru < catatanLama) {
                pecahRekod = true;
            }
        }

        if (pecahRekod) {
            REKOD_KEJOHANAN[kunci].catatan = catatan;
            return true;
        }
        return false;
    }

    function KiraMata(kedudukan, jenisAcara, rumah) {
        let mata;
        let pingat = '';
        
        if (jenisAcara === 'Individu') {
            mata = SKALA_MATA_INDIVIDU[kedudukan - 1] || 0;
        } else if (jenisAcara === 'Relay') {
            mata = SKALA_MATA_RELAY[kedudukan - 1] || 0;
        } else {
            mata = 0;
        }

        if (kedudukan === 1) pingat = 'Emas';
        else if (kedudukan === 2) pingat = 'Perak';
        else if (kedudukan === 3) pingat = 'Gangsa';

        // Kemas kini mata dan pingat rumah sukan
        if (rumah && MATA_RUMAH_SUKAN[rumah]) {
            MATA_RUMAH_SUKAN[rumah].mata += mata;
            if (pingat === 'Emas') MATA_RUMAH_SUKAN[rumah].emas += 1;
            else if (pingat === 'Perak') MATA_RUMAH_SUKAN[rumah].perak += 1;
            else if (pingat === 'Gangsa') MATA_RUMAH_SUKAN[rumah].gangsa += 1;
        }

        return { mata, pingat };
    }

    function KiraKedudukan(keputusanAcara) {
        // Sort kedudukan mengikut catatan
        // NOTA: Ini adalah logik mudah. Dalam sistem sebenar, ia lebih kompleks.
        
        // 1. Parse semua catatan ke nilai float dan tandakan jenis
        const dataPenuh = keputusanAcara.map(k => ({
            ...k,
            ...parseCatatan(k.catatan)
        })).filter(k => k.value > 0); // Buang yang tiada catatan

        if (dataPenuh.length === 0) return [];

        const isDistanceEvent = dataPenuh.some(k => k.isDistance);

        // 2. Sort data
        dataPenuh.sort((a, b) => {
            if (isDistanceEvent) {
                // Acara Padang: Catatan besar di atas (descending)
                return b.value - a.value;
            } else {
                // Acara Balapan (Masa): Catatan kecil di atas (ascending)
                return a.value - b.value;
            }
        });

        // 3. Tetapkan kedudukan dan kira mata
        let kedudukan = 1;
        const keputusanAkhir = [];
        
        for (let i = 0; i < dataPenuh.length; i++) {
            // Jika catatan sama dengan yang sebelumnya, kedudukan dikekalkan
            if (i > 0 && dataPenuh[i].value === dataPenuh[i-1].value) {
                // Jangan buat apa-apa
            } else {
                kedudukan = i + 1;
            }
            
            const { mata, pingat } = KiraMata(kedudukan, dataPenuh[i].jenis, dataPenuh[i].rumah);
            const pecahRekod = SemakRekod(dataPenuh[i].acara, dataPenuh[i].kategori, dataPenuh[i].catatan);
            
            keputusanAkhir.push({
                kedudukan: kedudukan,
                nama: dataPenuh[i].nama,
                rumah: dataPenuh[i].rumah,
                catatan: dataPenuh[i].catatan + (pecahRekod ? ' (REKOD BARU)' : ''),
                mata: mata,
                pingat: pingat,
                acara: dataPenuh[i].acara,
                kategori: dataPenuh[i].kategori,
                jenis: dataPenuh[i].jenis
            });
        }

        return keputusanAkhir;
    }

    function generateMataRumahSukanTable() {
        const container = document.getElementById('mata-rumah-sukan');
        let html = `
            <table>
                <tr>
                    <th>Rumah Sukan</th>
                    <th>Pingat Emas</th>
                    <th>Pingat Perak</th>
                    <th>Pingat Gangsa</th>
                    <th>Jumlah Mata</th>
                </tr>
        `;

        // Tukar objek MATA_RUMAH_SUKAN kepada array dan sort mengikut mata
        const sortedMata = Object.entries(MATA_RUMAH_SUKAN)
            .map(([nama, data]) => ({ nama, ...data }))
            .sort((a, b) => b.mata - a.mata);

        sortedMata.forEach(rumah => {
            html += `
                <tr class="${rumah.nama.toUpperCase()}">
                    <td>${rumah.nama}</td>
                    <td>${rumah.emas}</td>
                    <td>${rumah.perak}</td>
                    <td>${rumah.gangsa}</td>
                    <td>**${rumah.mata}**</td>
                </tr>
            `;
        });

        html += `</table>`;
        container.innerHTML = html;
    }

    function updateDashboard() {
        generateMataRumahSukanTable();
        
        const container = document.getElementById('keputusan-keseluruhan');
        container.innerHTML = ''; 

        // Kelompokkan keputusan mengikut Acara & Kategori
        const grouped = KEPUTUSAN_KESELURUHAN.reduce((acc, curr) => {
            const key = `${curr.acara} - ${curr.kategori}`;
            if (!acc[key]) {
                acc[key] = [];
            }
            acc[key].push(curr);
            return acc;
        }, {});

        for (const key in grouped) {
            const results = grouped[key].sort((a, b) => a.kedudukan - b.kedudukan);
            let html = `<div class="keputusan-acara">
                <h3>${key}</h3>
                <table>
                    <tr>
                        <th>Ked.</th>
                        <th>Nama/Pasukan</th>
                        <th>Rumah</th>
                        <th>Catatan</th>
                        <th>Mata</th>
                    </tr>
            `;

            results.forEach(k => {
                const pingatClass = k.pingat ? `pingat-${k.pingat}` : '';
                html += `
                    <tr class="${k.rumah.toUpperCase()} ${pingatClass}">
                        <td>**${k.kedudukan}**</td>
                        <td>${k.nama}</td>
                        <td>${k.rumah}</td>
                        <td>${k.catatan}</td>
                        <td>${k.mata}</td>
                    </tr>
                `;
            });

            html += `</table></div>`;
            container.innerHTML += html;
        }
    }

    // --- Fungsi Simpan Keputusan (Dinamik untuk Individu & Relay) ---

    function simpanKeputusanAcara() {
        const jenisAcara = document.getElementById('jenis-acara').value;
        const acara = document.getElementById('acara-dinamik').value;
        const kategori = document.getElementById('kategori-individu').value;

        if (!jenisAcara || !acara || !kategori) {
            alert('Sila lengkapkan semua medan.');
            return;
        }

        let keputusanInput = [];

        if (jenisAcara === 'Individu') {
            // Input Top 5
            for (let i = 1; i <= 5; i++) {
                const nama = document.getElementById(`n${i}`).value.trim();
                const rumah = document.getElementById(`r${i}`).value;
                const catatan = document.getElementById(`c${i}`).value.trim();
                
                if (nama && rumah && catatan) {
                    keputusanInput.push({
                        kedudukan: i,
                        nama: nama,
                        rumah: rumah,
                        catatan: catatan,
                        acara: acara,
                        kategori: kategori,
                        jenis: 'Individu'
                    });
                }
            }
            if (keputusanInput.length === 0) {
                alert('Sila masukkan sekurang-kurangnya tempat pertama dengan lengkap.');
                return;
            }
        } else if (jenisAcara === 'Relay') {
            // Input Top 4 (untuk relay)
            for (let i = 1; i <= 4; i++) {
                const rumah = document.getElementById(`rr${i}`).value;
                const catatan = document.getElementById(`rc${i}`).value.trim();
                
                if (rumah && catatan) {
                    keputusanInput.push({
                        kedudukan: i,
                        nama: `Pasukan ${rumah}`,
                        rumah: rumah,
                        catatan: catatan,
                        acara: acara, // Harusnya "4X100 METER"
                        kategori: kategori,
                        jenis: 'Relay'
                    });
                }
            }
            if (keputusanInput.length < 3) {
                alert('Sila masukkan sekurang-kurangnya tiga pasukan yang lengkap.');
                return;
            }
        }

        // Padam keputusan lama untuk acara/kategori yang sama
        KEPUTUSAN_KESELURUHAN = KEPUTUSAN_KESELURUHAN.filter(k => 
            !(k.acara === acara && k.kategori === kategori)
        );

        // Kira kedudukan sebenar, mata, dan semak rekod
        const keputusanBaru = KiraKedudukan(keputusanInput);
        
        // Tambah keputusan baru
        KEPUTUSAN_KESELURUHAN.push(...keputusanBaru);

        // Simpan ke Firebase
        simpanDataKeFirebase();

        // Kemas kini UI dan kosongkan borang
        updateDashboard();
        document.getElementById('form-individu').reset();
        // Reset dropdown jenis acara
        document.getElementById('jenis-acara').value = '';
        document.getElementById('acara-dinamik').innerHTML = '<option value="">Pilih Acara</option>';
        // Sembunyikan semua input field
        showHideInputFields('');
        alert(`Keputusan Acara ${acara} (${kategori}) telah disimpan.`);
    }

    // --- Fungsi Muat Naik Rekod ---

    function parseRekodCSV(text) {
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const rekodBaru = {};
        
        lines.forEach((line, index) => {
            // Ignore header row (index 0) if present
            if (index === 0 && line.toLowerCase().includes('acara')) return; 

            const parts = line.split(',').map(p => p.trim());
            if (parts.length < 5) return; // Skip baris tidak lengkap

            const [acara, kategori, nama, rumah, catatan] = parts;
            const kunci = `${acara.toUpperCase()}_${kategori.toUpperCase()}`;
            
            // Masukkan ke objek REKOD_KEJOHANAN
            rekodBaru[kunci] = {
                nama: nama,
                rumah: rumah,
                catatan: catatan,
                jenis: ACARA_PADANG.includes(acara.toUpperCase()) ? 'Padang' : 'Balapan'
            };
        });
        return rekodBaru;
    }

    function muatNaikRekod() {
        if (!auth.currentUser) {
             alert('RALAT: Anda mesti log masuk sebagai Admin untuk memuat naik rekod!');
             return;
        }

        const fileInput = document.getElementById('csv-rekod');
        const file = fileInput.files[0];

        if (!file) {
            alert('Sila pilih fail CSV.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const csvText = e.target.result;
            const rekodCSV = parseRekodCSV(csvText);
            
            // Gantikan rekod lama dengan yang baru dimuat naik
            REKOD_KEJOHANAN = rekodCSV; 
            
            // Simpan ke Firebase
            simpanDataKeFirebase();
            
            alert(`Berjaya memuat naik dan menyimpan ${Object.keys(rekodCSV).length} rekod kejohanan ke Firestore!`);
            console.log("Rekod Kejohanan yang Baru Dimuat Naik:", REKOD_KEJOHANAN);
            fileInput.value = ''; // Kosongkan input file
            showView('dashboard');
        };
        reader.readAsText(file);
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        muatDataDariFirebase(); // PANGGILAN BARU: Muat dari Firebase

        // Isi dropdown kategori umur
        const selectKategori = document.getElementById('kategori-individu');
        const kategoriOptions = KATEGORI_UMUR.map(k => `<option value="${k}">${k}</option>`).join('');
        selectKategori.innerHTML = kategoriOptions;

        // Isi dropdown Jenis Acara
        const selectJenisAcara = document.getElementById('jenis-acara');
        selectJenisAcara.innerHTML = `
            <option value="">Pilih Jenis</option>
            <option value="Individu">Acara Individu</option>
            <option value="Relay">Acara Relay</option>
        `;

        // Tambah event listener untuk update acara
        selectJenisAcara.addEventListener('change', updateAcaraDropdown);

        // Paparkan dashboard secara lalai
        document.getElementById('user-auth').style.display = 'block';
        showView('dashboard');

        // Muatkan senarai asas untuk dropdown "Acara" (optional)
        // Jika ingin default to Individu
        // updateAcaraDropdown();
    });
</script>
</body>

</html>

